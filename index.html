<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Earning App</title>
    <!-- Tailwind is NOT used, relying on custom CSS -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        .telegram-float {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background-color: #00ff00;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      cursor: pointer;
      z-index: 9999;
      transition: transform 0.3s ease;
      animation: popUp 0.8s ease;
    }

    .telegram-float img {
      width: 58px;
      height: 58px;
      filter: invert(100%);
    }

    .telegram-float:hover {
      transform: scale(1.1);
      background-color: #00ff00;
    }

    @keyframes popUp {
      0% { transform: scale(0); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

        :root {
            --primary-color: #007bff;
            --secondary-color: #28a745;
            --background-color: #f0f2f5;
            --card-background: #ffffff;
            --text-color: #333333;
            --light-text-color: #888888;
            --border-color: #e0e0e0;

            /* Custom Ad Colors for distinction */
            --ad-color-interstitial: #f97316; /* Orange */
            --ad-color-popup: #ef4444; /* Red */
            --ad-color-inapp: #10b981; /* Teal Green */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding-bottom: 60px;
            color: var(--text-color);
        }

        .container {
            max-width: 450px;
            margin: 0 auto;
            background-color: var(--card-background);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--card-background);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            border: 2px solid var(--primary-color);
            background-color: #eee;
            object-fit: cover;
        }

        .header-user-info h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .header-user-info p {
            margin: 0;
            font-size: 12px;
            color: var(--light-text-color);
        }

        .content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .card {
            background-color: var(--background-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .card-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .card-header .material-icons, .card-header .fa-solid {
            margin-right: 8px;
            color: var(--primary-color);
        }

        .balance-card .balance {
            font-size: 36px;
            font-weight: 700;
            color: var(--secondary-color);
            margin: 10px 0;
        }

        .card-label {
            font-size: 14px;
            color: var(--light-text-color);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .dashboard-item {
            background-color: var(--card-background);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .dashboard-item .material-icons {
            font-size: 32px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .dashboard-item-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-color);
        }

        .dashboard-item-label {
            font-size: 12px;
            color: var(--light-text-color);
        }

        .primary-btn, .secondary-btn {
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s, transform 0.2s;
            margin-top: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .primary-btn .material-icons, .secondary-btn .material-icons {
            font-size: 20px;
        }

        .primary-btn {
            background-color: var(--primary-color);
            color: #fff;
        }
        
        /* Specific Button Styles for Earn Page */
        .ad-btn-type {
            margin-top: 0 !important;
            display: flex;
            flex-direction: column;
            padding: 18px 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .ad-btn-type span:first-child {
            font-size: 18px;
        }

        .ad-btn-type:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .ad-btn-type:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .primary-btn:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        
        .primary-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .secondary-btn {
            background-color: #f0f0f0;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .secondary-btn:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
        }
        
        .progress-bar-container {
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 0;
            transition: width 0.5s ease-in-out;
        }

        .footer-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 450px;
            background-color: var(--card-background);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            color: var(--light-text-color);
            transition: color 0.3s;
            flex: 1;
        }

        .nav-item .material-icons, .nav-item .fa-solid {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .nav-item-label {
            font-size: 12px;
            font-weight: 500;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .page {
            display: none;
            animation: fadeIn 0.5s;
        }

        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Profile & Withdraw Page Styles (Existing styles retained) */
        .profile-info, .withdraw-form-container {
            background-color: var(--card-background);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }
        
        .profile-pic-container {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #eee;
            margin: 0 auto 15px;
            overflow: hidden;
            border: 3px solid var(--primary-color);
        }
        .profile-pic {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .profile-info-row:last-child {
            border-bottom: none;
        }
        .profile-label { font-size: 16px; color: var(--text-color); }
        .profile-value { font-size: 16px; font-weight: 600; color: var(--primary-color); }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 600;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            font-size: 16px;
        }
        
        .referral-link-container {
            display: flex;
            align-items: center;
            margin-top: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .referral-link-text {
            flex-grow: 1;
            padding: 10px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            text-align: left;
            font-size: 14px;
            color: var(--text-color);
        }
        .copy-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }
        .copy-btn:hover {
            background-color: #0056b3;
        }
        /* Style for Ad Status message */
        #ad-status-message {
            margin-top: 15px; 
            font-size: 14px; 
            color: var(--light-text-color); 
            min-height: 20px; /* Ensure space is reserved */
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <img id="header-profile-pic" src="https://via.placeholder.com/40" alt="Profile" class="header-profile-pic" onerror="this.src='https://via.placeholder.com/40';">
            <div class="header-user-info">
                <h3 id="header-user-name">User</h3>
                <p>Welcome to the Earning App!</p>
            </div>
        </header>
<!-- Telegram Floating Button -->
    <div class="telegram-float" id="telegramBtn">
    <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram">
    </div>
        <main class="content">
            <!-- HOME PAGE -->
            <section id="home-page" class="page active">
                <div class="card balance-card">
                    <h2 class="card-header">
                        <span class="material-icons">account_balance_wallet</span>
                        My Balance (আমার ব্যালেন্স)
                    </h2>
                    <div class="balance" id="current-balance">BDT 0.00</div>
                    <button class="primary-btn" id="start-earning-btn">
                        Start Earning Now (ইনকাম শুরু করুন) <span class="material-icons">arrow_forward</span>
                    </button>
                    <button class="secondary-btn" id="withdraw-btn">
                        Withdraw (উইথড্র) <span class="material-icons">currency_exchange</span>
                    </button>
                </div>
                <div class="dashboard-grid">
                    <div class="dashboard-item">
                        <span class="material-icons" style="color: var(--secondary-color);">attach_money</span>
                        <div class="dashboard-item-value" id="total-earnings">BDT 0.00</div>
                        <div class="dashboard-item-label">Total Earnings (মোট উপার্জন)</div>
                    </div>
                    <div class="dashboard-item">
                        <span class="material-icons" style="color: #ffc107;">visibility</span>
                        <div class="dashboard-item-value" id="ads-watched">0</div>
                        <div class="dashboard-item-label">Ads Watched (বিজ্ঞাপন দেখা হয়েছে)</div>
                    </div>
                </div>
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <span class="material-icons">group_add</span>
                        Invite & Earn (আমন্ত্রণ করুন ও উপার্জন করুন)
                    </div>
                    <div class="dashboard-item-value" id="total-referrals">0</div>
                    <div class="dashboard-item-label">Total Referrals (মোট রেফারেল)</div>
                    
                    <div class="referral-link-container">
                        <div class="referral-link-text" id="referral-link">Loading link...</div>
                        <button class="copy-btn" id="copy-referral-btn">
                            <span class="material-icons">content_copy</span>
                        </button>
                    </div>
                    <p style="font-size: 12px; color: var(--light-text-color); margin-top: 10px;" id="referral-reward-text">
                        Share this link to invite friends and earn **10% commission** per successful referral!
                    </p>
                </div>
            </section>

            <!-- EARN PAGE (UPDATED) -->
            <section id="earn-page" class="page">
                <div class="card">
                    <h2 class="card-header">
                        <span class="material-icons">monetization_on</span>
                        Earn Rewards (পুরস্কার উপার্জন)
                    </h2>
                    <div style="text-align: left; margin-bottom: 10px;">
                        <div style="font-size: 14px; font-weight: 600;">Today's Progress:</div>
                        <div style="font-size: 12px; color: var(--light-text-color);" id="ad-progress-text">Completed: 0 / 50</div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="ad-progress-bar"></div>
                    </div>
                    
                    <div id="ad-buttons-container" style="margin-top: 25px; display: grid; gap: 15px;">
                        <!-- Rewarded Interstitial -->
                        <button class="primary-btn ad-btn-type" data-ad-type="interstitial" style="background-color: var(--ad-color-interstitial);">
                            Rewarded Interstitial 
                            <span style="font-size: 14px; font-weight: 400;" id="reward-interstitial">(BDT 0.500)</span>
                            <span class="material-icons">play_circle_filled</span>
                        </button>

                        <!-- Rewarded Popup -->
                        <button class="primary-btn ad-btn-type" data-ad-type="popup" style="background-color: var(--ad-color-popup);">
                            Rewarded Popup 
                            <span style="font-size: 14px; font-weight: 400;" id="reward-popup">(BDT 0.500)</span>
                            <span class="material-icons">video_library</span>
                        </button>
                        
                        <!-- In-app Interstitial (Impression) -->
                        <button class="primary-btn ad-btn-type" data-ad-type="inapp" style="background-color: var(--ad-color-inapp);">
                            In-app Interstitial 
                            <span style="font-size: 14px; font-weight: 400;" id="reward-inapp">(BDT 0.500)</span>
                            <span class="material-icons">ad_units</span>
                        </button>
                    </div>
                    <p id="ad-status-message"></p>
                </div>
            </section>
            
            <!-- WITHDRAW PAGE -->
            <section id="withdraw-page" class="page">
                <div class="card">
                    <h2 class="card-header">
                        <span class="material-icons">currency_exchange</span>
                        Withdraw Your Earnings (উইথড্র করুন)
                    </h2>
                    <div class="balance" id="withdraw-balance-display">BDT 0.00</div>
                    <div class="card-label">Current Balance (বর্তমান ব্যালেন্স)</div>
                    <div style="margin-top: 20px; font-size: 14px; color: var(--light-text-color);">
                        Minimum withdraw amount is BDT 100.00 (সর্বনিম্ন উইথড্র)
                    </div>
                </div>
                
                <div class="withdraw-form-container">
                    <h4 style="margin-top: 0; text-align: left;">Withdraw Details</h4>
                    <form id="withdraw-form">
                        <div class="form-group">
                            <label for="withdraw-method">Withdraw Method (পদ্ধতি)</label>
                            <select id="withdraw-method" required>
                                <option value="" disabled selected>Select a method (পদ্ধতি নির্বাচন করুন)</option>
                                <option value="bkash">bKash</option>
                                <option value="binance">Binance</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="account-number">Account Number (অ্যাকাউন্ট নম্বর)</label>
                            <input type="text" id="account-number" placeholder="Enter bKash/Binance account number" required>
                        </div>
                        <div class="form-group">
                            <label for="withdraw-amount">Amount (BDT)</label>
                            <input type="number" id="withdraw-amount" placeholder="Enter amount to withdraw" required min="100">
                        </div>
                        <button type="submit" class="primary-btn" id="submit-withdraw-btn">
                            Submit Withdraw Request (উইথড্র অনুরোধ জমা দিন)
                        </button>
                    </form>
                </div>
            </section>

            <!-- PROFILE PAGE -->
            <section id="profile-page" class="page">
                <div class="card" style="padding: 30px;">
                    <div class="profile-pic-container">
                        <img id="profile-page-pic" src="https://via.placeholder.com/80" alt="Profile Picture" class="profile-pic" onerror="this.src='https://via.placeholder.com/80';">
                    </div>
                    <h3 id="profile-user-name" style="margin: 0; font-weight: 600;">User</h3>
                    <p id="profile-user-username" style="margin: 5px 0 0; color: var(--light-text-color); font-size: 14px;">@telegram</p>
                </div>
                <div class="profile-info">
                    <h4 style="margin-top: 0; text-align:left;">My Profile (আমার প্রোফাইল)</h4>
                    <div class="profile-info-row">
                        <span class="profile-label">Current Balance</span>
                        <span class="profile-value" id="profile-balance">BDT 0.00</span>
                    </div>
                    <div class="profile-info-row">
                        <span class="profile-label">Total Earnings</span>
                        <span class="profile-value" id="profile-earnings">BDT 0.00</span>
                    </div>
                    <div class="profile-info-row">
                        <span class="profile-label">Total Ads Watched</span>
                        <span class="profile-value" id="profile-ads-watched">0</span>
                    </div>
                    <div class="profile-info-row">
                        <span class="profile-label">Total Referrals</span>
                        <span class="profile-value" id="profile-referrals">0</span>
                    </div>
                </div>
            </section>
        </main>

        <nav class="footer-nav">
            <div class="nav-item active" data-page="home-page">
                <span class="material-icons">home</span>
                <span class="nav-item-label">Home</span>
            </div>
            <div class="nav-item" data-page="earn-page">
                <span class="material-icons">play_circle</span>
                <span class="nav-item-label">Earn</span>
            </div>
            <div class="nav-item" data-page="withdraw-page">
                <span class="fa-solid fa-credit-card"></span>
                <span class="nav-item-label">Withdraw</span>
            </div>
            <div class="nav-item" data-page="profile-page">
                <span class="material-icons">person</span>
                <span class="nav-item-label">Profile</span>
            </div>
        </nav>
    </div>
     
    <!-- Ad Network SDK Load - Retained from user's code -->
    <script src='//libtl.com/sdk.js' data-zone='9477103' data-sdk='show_9477103'></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
 // JavaScript for click event
    document.getElementById("telegramBtn").addEventListener("click", function() {
      window.open("https://t.me/SKCompany2024", "_blank");
    });

        // --- AD NETWORK SDK SIMULATION (FOR TESTING) ---
        if (typeof show_9477103 === 'undefined') {
            console.log('Ad SDK not found. Using dummy functions.');
            window.show_9477103 = function(config) {
                if (typeof config === 'object' && config.type === 'inApp') {
                    console.log('Dummy In-app Interstitial called with capping settings. Returns nothing.');
                    return;
                }
                const adType = config === 'pop' ? 'Rewarded Popup' : 'Rewarded Interstitial';
                console.log(`Dummy ${adType} called. Returning Promise.`);
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        if (Math.random() < 0.9) {
                            console.log(`Dummy ${adType} resolved successfully.`);
                            resolve();
                        } else {
                            console.log(`Dummy ${adType} rejected/closed prematurely.`);
                            reject(new Error('User closed ad or load failed.'));
                        }
                    }, 3000); 
                });
            }
        }
        
        // 1. Firebase Initialization
        const firebaseConfig = {
            apiKey: "AIzaSyAMVTLS_PK7M4yyMfcdKPHzn8yP1lXxpLQ",
            databaseURL: "https://text-4cc23-default-rtdb.firebaseio.com",
            projectId: "text-4cc23",
            storageBucket: "text-4cc23.appspot.com"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const database = firebase.database();

        // --- AD & APP CONFIGURATION ---
        const DAILY_ADS_LIMIT = 50;
        const MIN_WITHDRAW_AMOUNT = 100;
        
        // BOT_USERNAME updated to match the user's provided link structure
        const BOT_USERNAME = 'Earn_For_USDT_bot'; 
        
        // NEW COMMISSION LOGIC: 10% of the base ad reward
        const AD_REWARD_BASE = 0.50; // The standard reward for watching an ad
        const REFERRAL_COMMISSION_PERCENT = 0.10; // 10% commission requested by user
        const REFERRAL_REWARD = AD_REWARD_BASE * REFERRAL_COMMISSION_PERCENT; // Calculated BDT 0.05

        const AD_SETTINGS = {
            interstitial: {
                reward: AD_REWARD_BASE,
                call: () => show_9477103(), 
                type: 'rewarded_interstitial',
                name: 'Rewarded Interstitial'
            },
            popup: {
                reward: AD_REWARD_BASE,
                call: () => show_9477103('pop'), 
                type: 'rewarded_popup',
                name: 'Rewarded Popup'
            },
            inapp: {
                reward: AD_REWARD_BASE,
                call: () => show_9477103({
                    type: 'inApp',
                    inAppSettings: {
                        frequency: 2,
                        capping: 0.1,
                        interval: 30,
                        timeout: 5,
                        everyPage: false
                    }
                }),
                type: 'inapp_impression',
                name: 'In-app Interstitial',
                simulatedTime: 3 
            }
        };

        // 2. Main App Logic
        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            const userData = tg.initDataUnsafe.user || { id: null }; 

            const navItems = document.querySelectorAll('.nav-item');
            const pages = document.querySelectorAll('.page');
            const startEarningBtn = document.getElementById('start-earning-btn');
            const withdrawBtn = document.getElementById('withdraw-btn');
            const withdrawForm = document.getElementById('withdraw-form');
            const adButtons = document.querySelectorAll('.ad-btn-type');
            const adStatusMessage = document.getElementById('ad-status-message');
            
            // REFERRAL ELEMENTS
            const referralLinkElement = document.getElementById('referral-link');
            const copyReferralBtn = document.getElementById('copy-referral-btn');
            const referralRewardText = document.getElementById('referral-reward-text');
            
            // --- UPDATED LINK GENERATION using the user's requested format: /app?startapp=<USER_ID> ---
            const referralLinkTemplate = userData.id 
                ? `https://t.me/${BOT_USERNAME}/app?startapp=${userData.id}` 
                : 'Link not available. Open through Telegram.';
            // -----------------------------------------------------------------------------------------
            
            const defaultProfilePic40 = 'https://via.placeholder.com/40';
            const defaultProfilePic80 = 'https://via.placeholder.com/80';
            
            // Global variables to hold current user data from Firebase
            window.userEarnings = 0;
            window.userAdsWatched = 0;
            window.userReferrals = 0;

            // --- Firebase Data Management Functions ---
            function saveUserData(earnings, adsWatched, referrals, referredBy = null) { 
                if (userData && userData.id) {
                    database.ref('users/' + userData.id).update({
                        id: userData.id,
                        username: userData.username || 'N/A',
                        first_name: userData.first_name || 'N/A',
                        earnings: earnings,
                        adsWatched: adsWatched,
                        totalReferrals: referrals,
                        referredBy: referredBy, // Field to track who referred this user
                        last_update: new Date().toISOString()
                    });
                }
            }
            
            function updateAdRewardTexts() {
                // Formatting to three decimal places to show the full amount, e.g., 0.500
                document.getElementById('reward-interstitial').textContent = `(BDT ${AD_SETTINGS.interstitial.reward.toFixed(3)})`;
                document.getElementById('reward-popup').textContent = `(BDT ${AD_SETTINGS.popup.reward.toFixed(3)})`;
                document.getElementById('reward-inapp').textContent = `(BDT ${AD_SETTINGS.inapp.reward.toFixed(3)})`;
                
                // Update referral text with calculated commission
                referralRewardText.innerHTML = `বন্ধুদের আমন্ত্রণ জানাতে এই লিঙ্কটি শেয়ার করুন এবং প্রতি সফল রেফারেলের জন্য **${(REFERRAL_COMMISSION_PERCENT * 100).toFixed(0)}% কমিশন (BDT ${REFERRAL_REWARD.toFixed(2)})** উপার্জন করুন!`;
            }

            function loadAndSetupUser() {
                updateAdRewardTexts();

                if (userData && userData.id) {
                    referralLinkElement.textContent = referralLinkTemplate;
                    const currentUserId = String(userData.id); // Ensure ID is string for comparison

                    // BUG FIX: Change from once('value') to on('value') for real-time updates
                    database.ref('users/' + currentUserId).on('value', (snapshot) => {
                        let data = snapshot.val();
                        
                        if (!data) {
                            // Case 1: Brand new user
                            data = { earnings: 0, adsWatched: 0, totalReferrals: 0, referredBy: null };
                            // Initial save will happen below if referral is processed, otherwise save here.
                        }
                        
                        // Set global state from fetched data (or default for new user)
                        window.userEarnings = data.earnings || 0;
                        window.userAdsWatched = data.adsWatched || 0;
                        window.userReferrals = data.totalReferrals || 0;
                        
                        // --- REFERRAL COUNTING & REWARD LOGIC: Check for deep link parameter ---
                        const startParam = tg.initDataUnsafe.start_param;
                        
                        // Check if startParam exists, is a numeric ID string, and the user hasn't been referred yet
                        const isNumericId = /^\d+$/.test(startParam); // Checks if startParam is purely digits
                        
                        if (isNumericId && !data.referredBy) {
                            const referrerId = startParam; 
                            
                            // Check 3: Referrer ID must be valid and not the current user
                            if (referrerId !== currentUserId) {
                                console.log(`New referral detected! Referrer ID: ${referrerId}`);
                                
                                // 1. Update the REFERRER's referral count AND earnings (Transaction for safety)
                                database.ref('users/' + referrerId).transaction((currentReferrerData) => {
                                    if (currentReferrerData) {
                                        // Increment the count
                                        currentReferrerData.totalReferrals = (currentReferrerData.totalReferrals || 0) + 1;
                                        // ADD THE CALCULATED REFERRAL COMMISSION (10% of AD_REWARD_BASE)
                                        currentReferrerData.earnings = (currentReferrerData.earnings || 0) + REFERRAL_REWARD;
                                    }
                                    return currentReferrerData;
                                }, (error, committed, referrerSnapshot) => {
                                    if (error) {
                                        console.error("Referrer credit transaction failed:", error);
                                        tg.showAlert('রেফারেল ক্রেডিট দেওয়া সম্ভব হয়নি।');
                                    } else if (committed) {
                                        console.log(`Successfully credited referrer ${referrerId}. New Earnings: ${referrerSnapshot.val().earnings}`);
                                        
                                        // 2. Mark the CURRENT user as referred to prevent future repeat counts
                                        database.ref('users/' + currentUserId).update({
                                            referredBy: referrerId,
                                            // Initialize other user data if it was null
                                            earnings: data.earnings || 0,
                                            adsWatched: data.adsWatched || 0,
                                            totalReferrals: data.totalReferrals || 0
                                        }).then(() => {
                                            console.log('Current user marked as referred.');
                                            // Show a success message including the reward amount
                                            tg.showAlert(`আপনি সফলভাবে রেফারেল প্রোগ্রামে যুক্ত হয়েছেন! রেফারেন্স প্রদানকারী BDT ${REFERRAL_REWARD.toFixed(2)} কমিশন পেয়েছেন!`); 
                                        });
                                    }
                                });
                            }
                        } else {
                            // If user is not referred or referredBy is already set, just ensure data is saved
                            if (!snapshot.exists()) {
                                saveUserData(0, 0, 0, null); 
                            }
                        }
                        
                        // This call happens every time on('value') triggers, ensuring real-time UI updates
                        updateUI(); 
                    }, (error) => {
                         console.error("Firebase subscription error:", error);
                         tg.showAlert('ডেটা লোড করতে সমস্যা হচ্ছে। আপনার ইন্টারনেট সংযোগ পরীক্ষা করুন।');
                         updateUI(); 
                    });
                } else {
                    tg.showAlert('Error: Could not retrieve Telegram user ID.');
                    referralLinkElement.textContent = 'User ID not found.';
                    updateUI();
                }
            }
            // --- End Firebase Data Management Functions ---


            function updateUI() {
                const earnings = window.userEarnings || 0;
                const adsWatched = window.userAdsWatched || 0;
                const referrals = window.userReferrals || 0;

                const formattedEarnings = earnings.toFixed(2);
                
                // Set Ad buttons disabled state based on limit
                const isLimitReached = adsWatched >= DAILY_ADS_LIMIT;
                if (isLimitReached) {
                    adButtons.forEach(btn => btn.disabled = true);
                    adStatusMessage.textContent = 'দৈনিক বিজ্ঞাপনের সীমা পৌঁছে গেছে।';
                    adStatusMessage.style.color = '#ef4444';
                } else if (!adButtons[0].disabled) {
                    adStatusMessage.textContent = 'উপার্জন শুরু করার জন্য একটি বিজ্ঞাপনের ধরণ নির্বাচন করুন।';
                    adStatusMessage.style.color = 'var(--light-text-color)';
                }


                if(userData && userData.id) {
                    const fullName = `${userData.first_name || ''} ${userData.last_name || ''}`.trim();
                    document.getElementById('header-user-name').textContent = fullName || 'User';
                    document.getElementById('profile-user-name').textContent = fullName || 'User';
                    document.getElementById('profile-user-username').textContent = userData.username ? `@${userData.username}` : 'No username';
                    
                    if (userData.photo_url) {
                        const proxyUrl = 'https://api.allorigins.win/raw?url=';
                        const proxiedPhotoUrl = `${proxyUrl}${encodeURIComponent(userData.photo_url)}`;
                        document.getElementById('header-profile-pic').src = proxiedPhotoUrl;
                        document.getElementById('profile-page-pic').src = proxiedPhotoUrl;
                    } else {
                        document.getElementById('header-profile-pic').src = defaultProfilePic40;
                        document.getElementById('profile-page-pic').src = defaultProfilePic80;
                    }
                }

                // Update Home Page
                document.getElementById('current-balance').textContent = `BDT ${formattedEarnings}`;
                document.getElementById('total-earnings').textContent = `BDT ${formattedEarnings}`;
                document.getElementById('ads-watched').textContent = adsWatched;
                document.getElementById('total-referrals').textContent = referrals; 

                // Update Earn Page
                document.getElementById('ad-progress-text').textContent = `Completed: ${adsWatched} / ${DAILY_ADS_LIMIT}`;
                const progress = (adsWatched / DAILY_ADS_LIMIT) * 100;
                document.getElementById('ad-progress-bar').style.width = `${progress}%`;
                
                // Update Withdraw Page
                document.getElementById('withdraw-balance-display').textContent = `BDT ${formattedEarnings}`;
                document.getElementById('submit-withdraw-btn').disabled = earnings < MIN_WITHDRAW_AMOUNT;
                if(earnings < MIN_WITHDRAW_AMOUNT) document.getElementById('submit-withdraw-btn').textContent = `ন্যূনতম BDT ${MIN_WITHDRAW_AMOUNT} প্রয়োজন`;
                else document.getElementById('submit-withdraw-btn').textContent = 'Submit Withdraw Request';

                // Update Profile Page
                document.getElementById('profile-balance').textContent = `BDT ${formattedEarnings}`;
                document.getElementById('profile-earnings').textContent = `BDT ${formattedEarnings}`;
                document.getElementById('profile-ads-watched').textContent = adsWatched;
                document.getElementById('profile-referrals').textContent = referrals; 
            }

            function showPage(targetPageId) {
                navItems.forEach(nav => nav.classList.remove('active'));
                pages.forEach(page => page.classList.remove('active'));

                const activeNavItem = document.querySelector(`[data-page="${targetPageId}"]`);
                if (activeNavItem) activeNavItem.classList.add('active');
                
                const activePage = document.getElementById(targetPageId);
                if (activePage) activePage.classList.add('active');
            }
            
            function setAdButtonsDisabled(isDisabled, statusText = '') {
                adButtons.forEach(btn => btn.disabled = isDisabled);
                adStatusMessage.textContent = statusText;
                adStatusMessage.style.color = isDisabled ? '#007bff' : 'var(--light-text-color)';
            }


            // --- CORE AD WATCHER AND REWARD FUNCTION ---
            function watchAd(adType) {
                if (!userData.id) {
                    tg.showAlert('Application initialization error: User ID not found.');
                    return;
                }
                if (window.userAdsWatched >= DAILY_ADS_LIMIT) {
                    tg.showAlert('আপনার দৈনিক বিজ্ঞাপনের সীমা পৌঁছে গেছে।');
                    return;
                }
                
                const settings = AD_SETTINGS[adType];
                if (!settings) return;

                // Disable all buttons and show status
                setAdButtonsDisabled(true, `${settings.name} লোড হচ্ছে...`);

                // --- REWARDED ADS (Interstitial and Popup) ---
                if (settings.type.startsWith('rewarded')) {
                    
                    // The 'call' returns a Promise for rewarded ads
                    settings.call().then(() => {
                        // Success: user watched the ad till the end
                        processEarning(settings, settings.name);
                    }).catch(e => {
                        // Failure: ad error or user closed it before completion
                        console.error(`Ad failed for ${settings.name}:`, e);
                        tg.showAlert('বিজ্ঞাপনটি দেখাতে সমস্যা হয়েছে অথবা আপনি এটি সম্পূর্ণ দেখেননি। আবার চেষ্টা করুন।');
                        setAdButtonsDisabled(false, 'বিজ্ঞাপনটি সম্পূর্ণ দেখার চেষ্টা করুন।');
                        updateUI(); // Update UI to reflect limit status
                    });
                } 
                // --- IN-APP INTERSTITIAL (Impression-based) ---
                else if (settings.type === 'inapp_impression') {
                    // 1. Call the function with capping config
                    settings.call(); 

                    // 2. Simulate the impression time since it's non-rewarded/capping-based
                    let timeLeft = settings.simulatedTime;
                    
                    const interval = setInterval(() => {
                        if (timeLeft <= 0) {
                            clearInterval(interval);
                            // Assume impression registered and reward user
                            processEarning(settings, settings.name);
                        } else {
                            setAdButtonsDisabled(true, `${settings.name} চলছে... বাকি: ${timeLeft} সেকেন্ড।`);
                            timeLeft--;
                        }
                    }, 1000);
                }
            }

            function processEarning(settings, adName) {
                // Ensure data is saved as a transaction to prevent race conditions
                database.ref('users/' + userData.id).transaction((currentData) => {
                    if (currentData) {
                        currentData.earnings = (currentData.earnings || 0) + settings.reward;
                        currentData.adsWatched = (currentData.adsWatched || 0) + 1;
                        currentData.last_update = new Date().toISOString();
                    }
                    return currentData;
                }, (error, committed, snapshot) => {
                    if (error) {
                        console.error("Earning Transaction Failed:", error);
                        tg.showAlert("উপার্জন ব্যর্থ হয়েছে। ডাটাবেস ত্রুটি।");
                    } else if (committed) {
                        // The on('value') listener automatically updates window.userEarnings and calls updateUI()
                        window.userEarnings = snapshot.val().earnings; 
                        window.userAdsWatched = snapshot.val().adsWatched;
                        tg.showAlert(`${adName} দেখার জন্য আপনি BDT ${settings.reward.toFixed(3)} পেয়েছেন!`);
                    }
                    
                    setAdButtonsDisabled(false, '');
                    updateUI();
                });
            }
            // --- End Ad Logic ---


            // --- Event Listeners ---
            navItems.forEach(item => {
                item.addEventListener('click', () => showPage(item.getAttribute('data-page')));
            });

            startEarningBtn.addEventListener('click', () => showPage('earn-page'));
            withdrawBtn.addEventListener('click', () => showPage('withdraw-page'));
            
            // Ad Buttons Listener
            adButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const adType = btn.getAttribute('data-ad-type');
                    watchAd(adType);
                });
            });

            // Copy Referral Link Logic
            copyReferralBtn.addEventListener('click', () => {
                const link = referralLinkElement.textContent;
                
                if (tg.isClipboardAvailable) {
                    tg.copyText(link);
                    tg.showAlert('রেফারেল লিঙ্ক ক্লিপবোর্ডে কপি করা হয়েছে!');
                } else if (navigator.clipboard) {
                    navigator.clipboard.writeText(link).then(() => {
                        tg.showAlert('রেফারেল লিঙ্ক ক্লিপবোর্ডে কপি করা হয়েছে!');
                    }).catch(err => {
                        console.error('Could not copy text: ', err);
                        tg.showAlert('লিঙ্কটি কপি করা সম্ভব হয়নি। ম্যানুয়ালি কপি করুন: ' + link);
                    });
                } else {
                    tg.showAlert('লিঙ্কটি ম্যানুয়ালি কপি করুন: ' + link);
                }
            });
            
            // Withdrawal Logic (Retained)
            withdrawForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const amount = parseFloat(document.getElementById('withdraw-amount').value);
                const currentEarnings = window.userEarnings;
                
                if (currentEarnings < amount) {
                    tg.showAlert('ব্যালেন্স অপর্যাপ্ত।');
                    return;
                }

                tg.showConfirm(`আপনি BDT ${amount.toFixed(2)} উইথড্র করার অনুরোধ জমা দিতে চান কি?`, (confirmed) => {
                    if (confirmed) {
                        // 1. Deduct amount via transaction
                        database.ref('users/' + userData.id + '/earnings').transaction((currentEarnings) => {
                            if (currentEarnings >= amount) {
                                return currentEarnings - amount;
                            }
                            return undefined;
                        }, (error, committed, snapshot) => {
                            if (error || !committed) {
                                tg.showAlert('উইথড্রয়াল প্রক্রিয়া করতে ব্যর্থ হয়েছে। ডাটাবেস ত্রুটি বা অপর্যাপ্ত ব্যালেন্স।');
                                return;
                            }
                            
                            // 2. Deduction successful, create request for Admin Panel
                            const withdrawalRef = database.ref('withdrawal_requests').push();
                            withdrawalRef.set({
                                userId: userData.id,
                                userName: userData.first_name,
                                amount: amount, 
                                method: document.getElementById('withdraw-method').value,
                                account: document.getElementById('account-number').value,
                                date: new Date().toISOString(),
                                status: 'Pending'
                            });
                            
                            window.userEarnings = snapshot.val(); // Update global state from transaction result
                            
                            withdrawForm.reset();
                            updateUI();
                            tg.showAlert('আপনার উইথড্র অনুরোধ সফলভাবে জমা হয়েছে।');
                        });
                    }
                });
            });

            // Start by loading user data from Firebase
            loadAndSetupUser();
        });
    </script>
</body>
</html>

